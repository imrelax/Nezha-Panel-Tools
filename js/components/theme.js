// ä¸»é¢˜å’Œè¯­è¨€ç®¡ç†æ¨¡å—

// å›½é™…åŒ–æ–‡æœ¬é…ç½®
const i18n = {
    zh: {
        // åŸºç¡€æ–‡æœ¬
        title: 'å“ªå’é¢æ¿å·¥å…·',
        home: 'é¦–é¡µ',
        traffic: 'æµé‡ç›‘æ§',
        alert: 'å‘Šè­¦è§„åˆ™',
        about: 'å…³äº',
        english: 'è‹±æ–‡',
        close: 'å…³é—­',
        copy: 'å¤åˆ¶',
        refresh: 'åˆ·æ–°',
        
        // é¡µé¢å¯¼èˆª
        indexPage: 'è´¦å•é…ç½®',
        trafficPage: 'æµé‡ç›‘æ§',
        alertPage: 'è­¦æŠ¥é…ç½®',
        aboutPage: 'å…³äº',
        servicePage: 'æœåŠ¡',
        
        // é…ç½®æ ‡é¢˜
        billingConfig: 'è´¦å•é…ç½®',
        planConfig: 'å¥—é¤é…ç½®',
        jsonConfig: 'JSON é…ç½®',
        trafficMonitoring: 'æµé‡ç›‘æ§è§„åˆ™',
        alertRules: 'è­¦æŠ¥è§„åˆ™',
        
        // è¡¨å•å­—æ®µ
        type: 'ç±»å‹',
        ignoreList: 'å¿½ç•¥æœåŠ¡å™¨ (ç”¨é€—å·åˆ†éš”ID)',
        autoCalc: 'è‡ªåŠ¨è®¡ç®—',
        billingCycle: 'è®¡è´¹å‘¨æœŸ',
        minValue: 'æœ€å°å€¼',
        maxValue: 'æœ€å¤§å€¼',
        duration: 'æŒç»­æ—¶é—´ (ç§’)',
        cover: 'è¦†ç›–',
        ignoreServers: 'å¿½ç•¥æœåŠ¡å™¨ (ç”¨é€—å·åˆ†éš”ID)',
        trafficVolume: 'æµé‡é…é¢',
        trafficType: 'æµé‡ç±»å‹',
        inboundTraffic: 'å…¥ç«™æµé‡',
        outboundTraffic: 'å‡ºç«™æµé‡',
        bidirectionalTraffic: 'åŒå‘æµé‡',
        cycleStart: 'å‘¨æœŸå¼€å§‹',
        cycleInterval: 'å‘¨æœŸæ•°é‡',
        cycleUnit: 'å‘¨æœŸå•ä½',
        warning: 'è­¦å‘Š',
        cancel: 'å–æ¶ˆ',
        confirm: 'ç¡®è®¤',
        aboutUs: 'å…³äºæˆ‘ä»¬',
        toolTitle: 'å“ªå’é¢æ¿å·¥å…·',
        toolDescription: 'è¿™æ˜¯ä¸€ä¸ªä¸“ä¸ºå“ªå’ç›‘æ§é¢æ¿è®¾è®¡çš„JSONé…ç½®æ–‡ä»¶ç”Ÿæˆå·¥å…·ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€Ÿç”Ÿæˆå„ç§é…ç½®æ–‡ä»¶ã€‚',
        mainFeatures: 'ä¸»è¦åŠŸèƒ½ï¼š',
        feature1: 'è´¦å•é…ç½®ç”Ÿæˆ',
        feature2: 'å¥—é¤é…ç½®ç”Ÿæˆ',
        feature3: 'æµé‡ç›‘æ§è§„åˆ™é…ç½®',
        feature4: 'è­¦æŠ¥è§„åˆ™é…ç½®',
        feature5: 'æ”¯æŒä¸­è‹±æ–‡åˆ‡æ¢',
        feature6: 'æ·±è‰²æ¨¡å¼æ”¯æŒ',
        
        // é¡µè„š
        footerText: 'Â© 2025 Nezha Panel Tools. ä¿ç•™æ‰€æœ‰æƒåˆ©.',
        madeWith: 'ç”¨',
        and: 'å’Œ',
        madeBy: 'åˆ¶ä½œ',
        projectInfo: 'é¡¹ç›®ä¿¡æ¯',
        projectDescription: 'å“ªå’é¢æ¿JSONé…ç½®ç”Ÿæˆå·¥å…·',
        version: 'ç‰ˆæœ¬: 2.0.0',
        lastUpdate: 'æœ€åæ›´æ–°: 2025å¹´8æœˆ5æ—¥',
        relatedLinks: 'ç›¸å…³é“¾æ¥',
        sourceCode: 'æºä»£ç ',
        nezhaOfficial: 'å“ªå’å®˜ç½‘',
        authorSite: 'ä½œè€…ç½‘ç«™',
        siteRelated: 'æœ¬ç«™ç›¸å…³',
        siteSource: 'æœ¬ç«™æºç ',
        siteAuthor: 'æœ¬ç«™ä½œè€…',
        siteAbout: 'æœ¬ç«™è¯´æ˜',
        license: 'è®¸å¯è¯',
        licenseType: 'MIT License',
        openSource: 'å¼€æºå…è´¹ä½¿ç”¨',
        contribution: 'æ¬¢è¿è´¡çŒ®ä»£ç ',
        allRightsReserved: 'ä¿ç•™æ‰€æœ‰æƒåˆ©',
        
        // è¡¨å•æ ‡ç­¾
        billingInfo: 'è´¦å•ä¿¡æ¯',
        planInfo: 'å¥—é¤ä¿¡æ¯',
        startDate: 'å¼€å§‹æ—¥æœŸ',
        endDate: 'ç»“æŸæ—¥æœŸ',
        autoRenewal: 'è‡ªåŠ¨ç»­è´¹',
        cycle: 'å‘¨æœŸ',
        amount: 'é‡‘é¢',
        bandwidth: 'å¸¦å®½',
        traffic: 'æµé‡',
        networkRoute: 'ç½‘ç»œè·¯ç”±',
        extraTags: 'é¢å¤–æ ‡ç­¾',
        
        // å‘¨æœŸé€‰é¡¹
        cycles: {
            'Day': 'å¤©',
            'Week': 'å‘¨',
            'Month': 'æœˆ',
            'Quarter': 'å­£åº¦',
            'HalfYear': 'åŠå¹´',
            'Year': 'å¹´',
            '2Year': '2å¹´',
            '3Year': '3å¹´',
            '4Year': '4å¹´',
            '5Year': '5å¹´',
            'Permanent': 'æ°¸ä¹…'
        },
        
        cyclesEn: {
            'Day': 'Day',
            'Week': 'Week',
            'Month': 'Month',
            'Quarter': 'Quarter',
            'HalfYear': 'Half Year',
            'Year': 'Year',
            '2Year': '2 Years',
            '3Year': '3 Years',
            '4Year': '4 Years',
            '5Year': '5 Years',
            'Permanent': 'Permanent'
        },
        
        // æµé‡å‘¨æœŸé€‰é¡¹
        trafficPeriods: {
            'Day': 'å¤©',
            'Month': 'æœˆ',
            'Quarter': 'å­£åº¦',
            'Year': 'å¹´',
            'Unlimited': 'ä¸é™'
        },
        
        trafficPeriodsEn: {
            'Day': 'Day',
            'Month': 'Month',
            'Quarter': 'Quarter',
            'Year': 'Year',
            'Unlimited': 'Unlimited'
        },
        
        // å…¶ä»–æ–‡æœ¬
        unlimited: 'ä¸é™',
        refreshSuccess: 'åˆ·æ–°æˆåŠŸï¼',
        copySuccess: 'å¤åˆ¶æˆåŠŸ',
        devTeam: 'å¼€å‘å›¢é˜Ÿï¼š',
        
        // æœåŠ¡é¡µé¢
        serviceTitle: 'IPåœ°å€æœåŠ¡',
        serviceDescription: 'ä»¥ä¸‹IPæ•°æ®æ¥è‡ªäº’è”ç½‘ï¼Œä¸ä¿è¯å¯ç”¨æ€§ã€‚<br><br>å¦‚éœ€åé¦ˆé—®é¢˜æˆ–è·å–æ›´å¤šIPèµ„æºï¼Œè¯·è®¿é—®ï¼š<br><a href="https://github.com/imrelax/Nezha-Panel-Tools" target="_blank" class="text-blue-500 hover:text-blue-600 underline">https://github.com/imrelax/Nezha-Panel-Tools</a>',
        region: 'åœ°åŒº',
        unicom: 'è”é€š',
        mobile: 'ç§»åŠ¨',
        telecom: 'ç”µä¿¡',
        loading: 'åŠ è½½ä¸­...',
        loadError: 'åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'
    },
    
    en: {
        // åŸºç¡€æ–‡æœ¬
        title: 'Nezha Panel JSON Tools',
        home: 'Home',
        traffic: 'Traffic Monitor',
        alert: 'Alert Rules',
        about: 'About',
        english: 'English',
        close: 'Close',
        copy: 'Copy',
        refresh: 'Refresh',
        
        // é¡µé¢å¯¼èˆª
        indexPage: 'Billing Config',
        trafficPage: 'Traffic Monitor',
        alertPage: 'Alert Config',
        aboutPage: 'About',
        servicePage: 'Service',
        
        // é…ç½®æ ‡é¢˜
        billingConfig: 'Billing Configuration',
        planConfig: 'Plan Configuration',
        jsonConfig: 'JSON Configuration',
        trafficMonitoring: 'Traffic Monitoring Rules',
        alertRules: 'Alert Rules',
        
        // è¡¨å•å­—æ®µ
        type: 'Type',
        ignoreList: 'Ignore Servers (comma-separated IDs)',
        autoCalc: 'Auto Calculate',
        billingCycle: 'Billing Cycle',
        minValue: 'Min Value',
        maxValue: 'Max Value',
        duration: 'Duration (seconds)',
        cover: 'Cover',
        ignoreServers: 'Ignore Servers (comma-separated IDs)',
        trafficVolume: 'Traffic Volume',
        trafficType: 'Traffic Type',
        inboundTraffic: 'Inbound Traffic',
        outboundTraffic: 'Outbound Traffic',
        bidirectionalTraffic: 'Bidirectional Traffic',
        cycleStart: 'Cycle Start',
        cycleInterval: 'Cycle Interval',
        cycleUnit: 'Cycle Unit',
        warning: 'Warning',
        cancel: 'Cancel',
        confirm: 'Confirm',
        aboutUs: 'About Us',
        toolTitle: 'Nezha Panel JSON Quick Generation Tool',
        toolDescription: 'This is a JSON configuration file generation tool designed specifically for Nezha monitoring panel, helping users quickly generate various configuration files.',
        mainFeatures: 'Main Features:',
        feature1: 'Billing configuration generation',
        feature2: 'Plan configuration generation',
        feature3: 'Traffic monitoring rule configuration',
        feature4: 'Alert rule configuration',
        feature5: 'Support for Chinese and English switching',
        feature6: 'Dark mode support',
        
        // é¡µè„š
        footerText: 'Â© 2025 Nezha Panel Tools. All rights reserved.',
        madeWith: 'Made with',
        and: 'and',
        madeBy: 'by',
        projectInfo: 'Project Info',
        projectDescription: 'Nezha Panel JSON Configuration Generator',
        version: 'Version: 2.0.0',
        lastUpdate: 'Last Update: August 5, 2025',
        relatedLinks: 'Related Links',
        sourceCode: 'Source Code',
        nezhaOfficial: 'Nezha Official',
        authorSite: 'Author Site',
        siteRelated: 'Site Related',
        siteSource: 'Site Source',
        siteAuthor: 'Site Author',
        siteAbout: 'About Site',
        license: 'License',
        licenseType: 'MIT License',
        openSource: 'Open Source & Free',
        contribution: 'Contributions Welcome',
        allRightsReserved: 'All rights reserved',
        
        // è¡¨å•æ ‡ç­¾
        billingInfo: 'Billing Information',
        planInfo: 'Plan Information',
        startDate: 'Start Date',
        endDate: 'End Date',
        autoRenewal: 'Auto Renewal',
        cycle: 'Cycle',
        amount: 'Amount',
        bandwidth: 'Bandwidth',
        traffic: 'Traffic',
        networkRoute: 'Network Route',
        extraTags: 'Extra Tags',
        
        // å‘¨æœŸé€‰é¡¹
        cycles: {
            'Day': 'Day',
            'Week': 'Week',
            'Month': 'Month',
            'Quarter': 'Quarter',
            'HalfYear': 'Half Year',
            'Year': 'Year',
            '2Year': '2 Years',
            '3Year': '3 Years',
            '4Year': '4 Years',
            '5Year': '5 Years',
            'Permanent': 'Permanent'
        },
        
        cyclesEn: {
            'Day': 'Day',
            'Week': 'Week',
            'Month': 'Month',
            'Quarter': 'Quarter',
            'HalfYear': 'Half Year',
            'Year': 'Year',
            '2Year': '2 Years',
            '3Year': '3 Years',
            '4Year': '4 Years',
            '5Year': '5 Years',
            'Permanent': 'Permanent'
        },
        
        // æµé‡å‘¨æœŸé€‰é¡¹
        trafficPeriods: {
            'Day': 'Day',
            'Month': 'Month',
            'Quarter': 'Quarter',
            'Year': 'Year',
            'Unlimited': 'Unlimited'
        },
        
        trafficPeriodsEn: {
            'Day': 'Day',
            'Month': 'Month',
            'Quarter': 'Quarter',
            'Year': 'Year',
            'Unlimited': 'Unlimited'
        },
        
        // å…¶ä»–æ–‡æœ¬
        unlimited: 'Unlimited',
        refreshSuccess: 'Refresh successful',
        copySuccess: 'Copy successful',
        devTeam: 'Development Team:',
        
        // æœåŠ¡é¡µé¢
        serviceTitle: 'IP Address Service',
        serviceDescription: 'The following IP data comes from the internet and availability is not guaranteed.<br><br>For feedback or more IP resources, please visit:<br><a href="https://github.com/imrelax/Nezha-Panel-Tools" target="_blank" class="text-blue-500 hover:text-blue-600 underline">https://github.com/imrelax/Nezha-Panel-Tools</a>',
        region: 'Region',
        unicom: 'China Unicom',
        mobile: 'China Mobile',
        telecom: 'China Telecom',
        loading: 'Loading...',
        loadError: 'Loading failed, please try again later'
    }
};

// å›½é™…åŒ–è¾…åŠ©å‡½æ•°
function __(key, lang = null) {
    const currentLang = lang || (typeof state !== 'undefined' ? state.language : 'zh');
    return i18n[currentLang] && i18n[currentLang][key] ? i18n[currentLang][key] : key;
}

// Tailwind CSS é…ç½®
window.tailwindConfig = {
    darkMode: 'class',
    theme: {
        extend: {
            colors: {
                primary: {
                    50: '#f3f6fb',
                    100: '#e3edfa',
                    500: '#2563eb',
                    600: '#1d4ed8',
                    900: '#1e293b'
                }
            },
            backdropBlur: {
                xs: '2px'
            }
        }
    }
};

// åº”ç”¨ Tailwind é…ç½®
if (typeof tailwind !== 'undefined') {
    tailwind.config = window.tailwindConfig;
}

// åˆå§‹åŒ–ä¸»é¢˜ - è‡ªåŠ¨æ£€æµ‹æµè§ˆå™¨ä¸»é¢˜
function initializeTheme() {
    // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ä¸»é¢˜åå¥½
    const savedTheme = localStorage.getItem('theme');
    
    if (savedTheme) {
        // å¦‚æœæœ‰ä¿å­˜çš„ä¸»é¢˜ï¼Œä½¿ç”¨ä¿å­˜çš„ä¸»é¢˜
        setTheme(savedTheme);
    } else {
        // å¦‚æœæ²¡æœ‰ä¿å­˜çš„ä¸»é¢˜ï¼Œè‡ªåŠ¨æ£€æµ‹æµè§ˆå™¨ä¸»é¢˜
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const autoTheme = prefersDark ? 'dark' : 'light';
        setTheme(autoTheme);
    }
    
    // ç›‘å¬æµè§ˆå™¨ä¸»é¢˜å˜åŒ–
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    mediaQuery.addEventListener('change', (e) => {
        // åªæœ‰åœ¨æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®ä¸»é¢˜æ—¶æ‰è‡ªåŠ¨è·Ÿéšæµè§ˆå™¨ä¸»é¢˜
        if (!localStorage.getItem('theme')) {
            const newTheme = e.matches ? 'dark' : 'light';
            setTheme(newTheme);
        }
    });
}

// ä¸»é¢˜åˆ‡æ¢
function toggleTheme() {
    // ä» localStorage æˆ– DOM è·å–å½“å‰ä¸»é¢˜
    const currentTheme = localStorage.getItem('theme') || 
                        (document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
}

function setTheme(theme) {
    // æ›´æ–°å…¨å±€çŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (typeof state !== 'undefined') {
        state.theme = theme;
    }
    
    document.documentElement.setAttribute('data-theme', theme);
    
    // ä¸ºTailwind CSSæ·»åŠ darkç±»
    if (theme === 'dark') {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark');
    }
    
    // æ›´æ–°ä¸»é¢˜åˆ‡æ¢æŒ‰é’®å›¾æ ‡
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
        const icon = themeToggle.querySelector('i');
        if (icon) {
            icon.className = '';
    icon.textContent = theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        }
    }
    
    // ä¿å­˜ä¸»é¢˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œè¡¨ç¤ºç”¨æˆ·å·²æ‰‹åŠ¨è®¾ç½®
    localStorage.setItem('theme', theme);
}

// è¯­è¨€åˆ‡æ¢
function toggleLanguage() {
    // ä» localStorage è·å–å½“å‰è¯­è¨€
    const currentLanguage = localStorage.getItem('language') || 'zh';
    const newLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
    setLanguage(newLanguage);
}

function setLanguage(language) {
    // æ›´æ–°å…¨å±€çŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (typeof state !== 'undefined') {
        state.language = language;
    }
    
    // æ˜¾ç¤ºç›¸åçš„è¯­è¨€åç§°ä½œä¸ºåˆ‡æ¢æç¤º
    const langIndicator = document.getElementById('lang-indicator');
    if (langIndicator) {
        langIndicator.textContent = language === 'zh' ? 'English' : 'ä¸­æ–‡';
    }
    
    // æ›´æ–°è¯­è¨€åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
    const zhSpans = document.querySelectorAll('.language-zh');
    const enSpans = document.querySelectorAll('.language-en');
    
    if (language === 'zh') {
        zhSpans.forEach(span => span.classList.remove('hidden'));
        enSpans.forEach(span => span.classList.add('hidden'));
    } else {
        zhSpans.forEach(span => span.classList.add('hidden'));
        enSpans.forEach(span => span.classList.remove('hidden'));
    }
    
    // æ›´æ–°æ‰€æœ‰æ–‡æœ¬
    document.querySelectorAll('[data-key]').forEach(element => {
        const key = element.getAttribute('data-key');
        if (i18n[language] && i18n[language][key]) {
            const content = i18n[language][key];
            // å®‰å…¨å¤„ç†HTMLå†…å®¹
            if (content.includes('<') && content.includes('>')) {
                // å¯¹äºåŒ…å«HTMLçš„å†…å®¹ï¼Œè¿›è¡Œå®‰å…¨å¤„ç†
                element.innerHTML = sanitizeHtml(content);
            } else {
                // çº¯æ–‡æœ¬å†…å®¹ä½¿ç”¨textContent
                element.textContent = content;
            }
        }
    });
    
    // æ›´æ–°å‘¨æœŸé€‰é¡¹
    if (typeof updateCycleOptions === 'function') updateCycleOptions();
    if (typeof updateTrafficPeriodOptions === 'function') updateTrafficPeriodOptions();
    if (typeof updateCurrencyFormatOptions === 'function') updateCurrencyFormatOptions();
    
    localStorage.setItem('language', language);
    if (typeof updateJsonCode === 'function') updateJsonCode();
}



// HTMLå†…å®¹å‡€åŒ–å‡½æ•°
function sanitizeHtml(html) {
    // å…è®¸çš„æ ‡ç­¾å’Œå±æ€§ç™½åå•
    const allowedTags = ['a', 'br', 'span', 'strong', 'em', 'p'];
    const allowedAttributes = {
        'a': ['href', 'target', 'class'],
        'span': ['class'],
        'strong': ['class'],
        'em': ['class'],
        'p': ['class']
    };
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    
    // é€’å½’æ¸…ç†å…ƒç´ 
    function cleanElement(element) {
        const tagName = element.tagName.toLowerCase();
        
        // æ£€æŸ¥æ ‡ç­¾æ˜¯å¦åœ¨ç™½åå•ä¸­
        if (!allowedTags.includes(tagName)) {
            // ä¸å…è®¸çš„æ ‡ç­¾ï¼Œä¿ç•™æ–‡æœ¬å†…å®¹
            const textNode = document.createTextNode(element.textContent);
            element.parentNode.replaceChild(textNode, element);
            return;
        }
        
        // æ¸…ç†å±æ€§
        const allowedAttrs = allowedAttributes[tagName] || [];
        const attrs = Array.from(element.attributes);
        attrs.forEach(attr => {
            if (!allowedAttrs.includes(attr.name)) {
                element.removeAttribute(attr.name);
            }
        });
        
        // é€’å½’å¤„ç†å­å…ƒç´ 
        Array.from(element.children).forEach(child => {
            cleanElement(child);
        });
    }
    
    Array.from(tempDiv.children).forEach(child => {
        cleanElement(child);
    });
    
    return tempDiv.innerHTML;
}

// å¯¼å‡ºå‡½æ•°ï¼ˆå¦‚æœæ”¯æŒæ¨¡å—åŒ–ï¼‰
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        initializeTheme,
        toggleTheme,
        setTheme,
        toggleLanguage,
        setLanguage,
        sanitizeHtml
    };
}